const express = require('express');
const server = express();
const port = 8888;

// discord
const discord = require('discord.js');
var client = new discord.Client();
var token = undefined;
var dis_resData = {};
var dis_prefix = '%';
var guild = undefined;
var guild_channels = undefined;
var guild_emojis = undefined;
var guild_members = undefined;
var guild_roles = undefined;
var guild_client = undefined;

var currentPost = undefined;

	// emojis
var emoji_catalog = {};
	// Roles
var role_catalog = {};
	// Members
var member_catalog = {};

var emojiToRole = {
	"news" : "News Alerts",
	"R6" : "Rainbow Six Siege",
	"warframe" : "Warframe",
	"anthem" : "Anthem",
	"youtube" : "YouTube Alerts",
	"twitch" : "Stream Alerts",
	"forhonor" : "For Honor",
	"apexlegends" : "Apex Legends"
}
var unauthed_users = {};

var msg_sevarity = {
	low : {
		color : "GREEN",
		here  : false,
		everyone : false 
			},
	med : {
		color : "ORANGE",
		here  : true,
		everyone : false
			},
	high: {
		color : "RED",
		here : false,
		everyone  : true
			},
	crit: {
		color : "PURPLE",
		here : false,
		everyone  : true
			}
}

var pollActive = false;

// Vue.js
const vue = require('vue');

// bootstrap
//require('bootstrap');

// fs
const fs = require('fs');

// Main function (primes everything)
function main(){
	console.log('Booted successfully...');
	token = fs.readFileSync(`${__dirname}/token.dat`).toString().trim();
	// console.log(token);
	
	discordPrimer();
		
	discordLogin();
}

// Server functions
server.listen(port, () => { 
	console.log(`Express server listening on port ${port}...`);
	if(main != undefined){
		main();
	}
});

var saveData = {
	saveMessage : {
		id: ""
	}
}


server.get('/', function(req, res){
	res.send('hello world!');
});
server.post('/', function(req, res){
	res.send('this is a post request.')
});
server.get('/dis_bot', function(req, res) {
	res.send(req.query);
	dis_resData = res.query;
});
server.get('/dis_bot/guild', function(req, res){
	res.send(guild);
});
server.get('/dis_bot/guild/members', function(req, res) {
	let mems = {};
	guild_members.forEach((el, i) => {
		mems[i] = {
			username: el.username,
			id: el.id
		};
	});
	res.send(mems);
});
server.get('/dis_bot/guild/channels', function(req, res) {
	res.send(guild_channels.array());
});
server.get('/dis_bot/guild/emojis', function(req, res) {
	res.send(guild_emojis.array());
});
server.get('/dis_bot/guild/emoji_catalog', function(req, res) {
	res.send(emoji_catalog);
});

// Discord Functions
function discordLogin(callback){
	client.login(token)
	.then(() => {
		if(callback) 
			callback();
	})
	.catch( err => {
		if(callback)
			callback(err);
		else
			throw err;
	});

}

client.on('guildMemberAdd', member => {
	var val = Math.floor(1000 + Math.random() * 9000);
	member.send(`To prove your not a dasterdly robot, please type this \`auth ${val}\``);
	unauthed_users[member.user.username] = {"capcha": val, "member": member};
});

function discordPrimer(){
	
	
	
}

client.on('ready', () => {
	console.log('Bot connected to Discord API...');
	guild = client.guilds.first();
	guild_members = client.guilds.first().members;
	guild_channels = client.guilds.first().channels;
	guild_roles = client.guilds.first().roles;
	guild_emojis = client.guilds.first().emojis;
	guild_client = client.guilds.first().client;
	
	checkSaveFile();
	
	
	guildPrimer();	// This function will set the rules for how to bot responds with different messages.
	getEmojis();	// This function gets the emoji's and puts them into a new object called emoji_catalog. It only takes the emoji's name's and id's.
	getRoles();		// This function gets the roles and puts them into a new object called roles_catalog. It only takes the role's names and id's.
	getMembers();	// This function gets the members and puts them into a new object called members_catalog. It only takes the member's usernames and id's.
});

client.on('message', msg => {
	console.log('A message was sent somewhere...');
	if(msg.guild)
		discordComm(msg);
	else
		discordDM(msg);	
		
});


function guildPrimer(){
	/*guild_client.on('message', msg => {
		if(msg.guild){
			if(msg.content.startsWith(dis_prefix)){
				discordComm(msg);
			}
		}
		else
			discordDM(msg);	
		
	});*/

}

function discordDM(msg){
	if(msg.mentions.users.size > 0 ){
		let usr_mentions = msg.mentions.users;
		if(usr_mentions.has(client.user.id)){
			console.log('Found a mention of me...');
			if(msg.content.toLowerCase().includes(' hello') || msg.content.toLowerCase().includes(' hi')){
				msg.channel.send(`Hey there, ${msg.author}!`);
			}
			
		}	
			
	}
	console.log('Was sent a DM...');
	if(msg.content.startsWith(`auth`)){
		
		let dataArr = msg.content.split(' ');
		if(unauthed_users[msg.author.username]){
			if(parseInt(dataArr[1]) === unauthed_users[msg.author.username].capcha){
				// authorized the user
				msg.author.send(`**You have been __authorized!__**\nWelcome to the server, not a robot!\n\nIf you need a list of commands, just messgae me \`help\` or use the \`%help\` command in the discord.\nMy prefix for commands is \`%\`. (I know it's weird, just deal with it.)`);
				unauthed_users[msg.author.username].member.addRole(guild_roles.find(role => role.name === "Verified"));
				unauthed_users[msg.author.username] = undefined;
			}
			else{
				msg.author.send('That wasn\'t the right code.');
				console.log(`User ${msg.author.username} failed to authenticate...`);
			}
		}
		else{
			msg.author.send('That is not the right code, capcha failed.');
			console.log(`I cant find the user ${msg.author.username} in the unauthed user list...\n`);
		}
	}
	
}

function discordComm(msg){
	console.log('A message was sent in the guild...');
	if(msg.content.startsWith(dis_prefix)){
		// Everyone
		let usr_mentions = undefined;
		if(msg.mentions.users.array().length > 0)
			usr_mentions = msg.mentions.users;
		
		if(msg.content === `${dis_prefix}help`){
			msg.channel.send(`Lemme message you with some basic commands, ${msg.author}... One second!`);
			msg.author.send('SIKE! I HAVE NO COMMANDS BOI! YEET! :joy:')
			.catch( (err) => {
				msg.channel.send('I can\'t send a message to you. Check your privacy settings?');
			});
		}
		else if(msg.content === `${dis_prefix}devo`){
			let devo = {};
			guild_members.forEach(person => {
				console.log(person.user.username);
				if(person.user.username.includes('devo'))
					devo = person;
				else if(person.id === '367500108163579904')
					devo = person;
			});
			msg.channel.send(`${devo} looks like a thumb.\n`);
		}
		else if(msg.content.startsWith(`${dis_prefix}`)){
			msg.channel.send('That is not a command.');
			
		}

		// Admins
		if(msg.guild && msg.member.hasPermission(discord.Permissions.FLAGS.ADMINISTRATOR)){
			if(msg.content.toLowerCase() === `${dis_prefix}resetmessage`){
				msg.delete();
				discordPostRoleAss();
			}
			if(msg.content.toLowerCase() === `${dis_prefix}reload`){
				refreshServerData();
			}
			if(msg.content.toLowerCase().startsWith(`${dis_prefix}post `) ){
				if(msg.content.toLowerCase().substring(6).startsWith('update ')){
					postUpdate(msg.content.substring(13), msg);
				}
			}
			
		}
		if(msg.guild && (msg.member.hasPermission(discord.Permissions.FLAGS.ADMINISTRATOR) || msg.member.roles.find("name", "Announcer") )){
			
			if(msg.content.toLowerCase().startsWith(`${dis_prefix}announce `) ){
				let msg_arr = msg.content.split(" ");
				// index 0: start of command
				// index 1: sevarity
				// index 3+: Message
				
				// if the sevarity given is in the list of levels...
				if(msg_sevarity[msg_arr[1].toLowerCase()]){
					// post the announcement with the given sevarity
					postAnnouncement(msg.content.slice(msg.content.indexOf(msg_arr[1]) + msg_arr[1].length + 1), msg.author.username, msg_arr[1].toLowerCase());
					msg.delete();
				}
				else{
					cmdError()
					let embed_msg = new discord.RichEmbed();
						embed_msg.setTitle('Incorrect Syntax');
						embed_msg.setDescription('I expected some format and you did not follow it :(');
						embed_msg.setColor(0xFF0000);
						embed_msg.addField('Expected', '`%announce <low|med|high|crit> <message>`');
						embed_msg.addField('Given', `\`${msg_arr[0]} ${msg_arr[1]} <message>\``);	
	
					msg.channel.send(embed_msg);
				}
				
				
			}
			else if(msg.content.toLowerCase().startsWith(`${dis_prefix}poll `)){
				let msg_arr = msg.content.split(" ");
				// index 0: command start
				// index 2: lol the message dummy
				makePoll(msg.content.slice(6), msg.author.username);
				msg.delete();
				
				
			}
		}
		
				
	}

}

/**
	* This function sends a message into the role assignment channel and adds reactions to it for people to also react to and recieve/remove a corresponding role
	*/
function discordPostRoleAss(){
	guild_channels.array().forEach( function(chnl){
		// console.log(chnl);
		if(chnl.name === 'role-assignment' && chnl.manageable && chnl.type === 'text'){
			// getting the text from a file and sending it to the server channel 'role assignment'
			let message = fs.readFileSync(`${__dirname}/role-assignment-message.md`);
			
			message = message.toString();
			message = insertEmojis(message);
			let message_split = message.split(';');
				
			let embed_msg = new discord.RichEmbed();
				embed_msg.setTitle('Welcome to TDefton\'s Server!');
				embed_msg.setDescription(message);
				embed_msg.setColor("RANDOM");
			if(currentPost && currentPost.editable){
				console.log("Post already available; modifying the previous post...");
				currentPost.edit(embed_msg)
				.then(msg => {
					msg.react(emoji_catalog.news.id);
					msg.react(emoji_catalog.R6.id);
					msg.react(emoji_catalog.warframe.id);
					msg.react(emoji_catalog.anthem.id);
					msg.react(emoji_catalog.youtube.id);
					msg.react(emoji_catalog.twitch.id);
					msg.react(emoji_catalog.forhonor.id);
					msg.react(emoji_catalog.apexlegends.id);
				})
				.catch(err => {
					console.log("Something went wrong...\n" + err)
				});
			
			}
			else{	
				chnl.send(embed_msg)
				.then((msg) => {
					msg.react(emoji_catalog.news.id);
					msg.react(emoji_catalog.R6.id);
					msg.react(emoji_catalog.warframe.id);
					msg.react(emoji_catalog.anthem.id);
					msg.react(emoji_catalog.youtube.id);
					msg.react(emoji_catalog.twitch.id);
					msg.react(emoji_catalog.forhonor.id);	
					msg.react(emoji_catalog.apexlegends.id);	
					currentPost = msg;
					// console.log(currentPost);
					saveData.saveMessage.id = msg.id;
					fs.writeFileSync(`${__dirname}/data.json`, JSON.stringify(saveData) );
				});
			}
			
			
			
			addReactionEvents();
		}
	});			
}

function insertEmojis(message){
	guild_emojis.forEach(el => {
		if(message.includes(`:${el.name}:`)){
			let find = new RegExp(`:${el.name}:`, "g");
			message = message.replace( find, toEmoji(emoji_catalog[el.name]) );
		} 
	});
	
	message = message.replace(/;/g, '\n');
	return message;
}

function getEmojis(){
	guild_emojis.array().forEach(el => {
		emoji_catalog[el.name] = el;
	});
	// console.log(emoji_catalog);
}

function getRoles(){
	guild_roles.array().forEach(el => {
		role_catalog[el.name] = el;
	});
	// console.log(role_catalog);
}

function getMembers(){
	guild_members.array().forEach(el => {
		member_catalog[el.id] = el;
	});
	// console.log(member_catalog);
}


function toEmoji(emojiData){
	let emoji = `<:${emojiData.name}:${emojiData.id}>`
	return emoji;
}

function addReactionEvents(){
	guild_client.on('messageReactionAdd', (messageReaction, usr) => {
		let mem = guild_members.get(usr.id);	
		if(currentPost.id === messageReaction.message.id && usr.username != client.user.username){
			
			let emojiName = messageReaction.emoji.name;
			if(role_catalog[ emojiToRole[emojiName] ]){
				mem.addRole(role_catalog[ emojiToRole[emojiName] ].id, `${usr.username} reacted with the corresponding emote.`)
				.then(function(){
					console.log(`Assigned user ${usr.username} the role of ${guild_roles.get(role_catalog[ emojiToRole[emojiName] ].id).name}.`);
				})
				.catch(console.log);
			}
			else{	
				console.log('Unable to find corresponding role... Removing reaction...');			
				messageReaction.remove(usr);
			}

		}
		// If it turns out that it is the bot creating the post or the user is reacting to a different message.
		else{
			console.log(`${usr.username} reacted to a post...`)
		}
	});
			
	guild_client.on('messageReactionRemove', (messageReaction, usr) => {
		let mem = guild_members.get(usr.id);	
		if(currentPost.id === messageReaction.message.id && usr.username != client.user.username){
			
			let emojiName = messageReaction.emoji.name;
			if(role_catalog[ emojiToRole[emojiName] ]){
				mem.removeRole(role_catalog[ emojiToRole[emojiName] ].id, `${usr.username} reacted with the corresponding emote.`)
				.then(function(){
					console.log(`Removed the user ${usr.username} from the role of ${guild_roles.get(role_catalog[ emojiToRole[emojiName] ].id).name}.`);
				})
				.catch(console.log);
			
			}
			else{
				console.log('Unable to find corresponding role... Changing nothing...')
			
			}
		}
	});
}

function checkSaveFile(){
	try{
		data = JSON.parse( fs.readFileSync(`${__dirname}/data.json`) );
		if(data.saveMessage.id != ""){
			guild_channels.forEach((el) => {
				if(el.name === "role-assignment" && el.type === "text"){
					el.fetchMessage(data.saveMessage.id)
					.then(message => {
						currentPost = message;
						console.log('Found my old post...');
						addReactionEvents();
					})
					.catch(console.log);
				}
			});
			
		}
	}
	catch(e){
		console.log(`There was a problem retrieving the save file\n${e}`);
	}
}

function refreshServerData(){
	checkSaveFile();
	getMembers();
	getMembers();
	getRoles();
}

function postUpdate(content, msg){
	guild_channels.forEach(el => {
		if(el.name === "bot-updates" && el.type === "text"){
			let message = insertEmojis(content);
			el.send(content)
			.then(newMessage => {
				msg.delete();
			});
		}
	});
}

function dynamicRoomCreation(){
	if(msg.sontent.startsWith(`${dis_prefix}newroom `)){
		
	}
	guild_channels.get();
}

function messagePermission(msg){
	if(msg.content.includes('https://') || msg.content.includes('http://')){
		
	}
}


function makeEmbed(title, message, color, field=[], footer=""){
	let embed_msg = new discord.RichEmbed();
		embed_msg.setTitle(title);
		embed_msg.setDescription(message);
		embed_msg.setColor(color);
		embed_msg.setFooter(footer);
	if(field !== [])	
		field.forEach( function(el) {
			embed_msg.addField(el);
		});
	return embed_msg;
}

function cmdError(title, message, color, field=[], footer=""){
	return makeEmbed(title, message, color, field, footer);
}


function makePoll(str, username){
	if(!pollActive){
		guild_channels.array().forEach( function(chnl){
			if(chnl.name === 'polls' && chnl.manageable && chnl.type === 'text'){
				let embed_msg = new discord.RichEmbed();
					embed_msg.setTitle('Poll');
					embed_msg.setDescription(str);
					embed_msg.setColor(0x1153FF);
					embed_msg.setFooter(`Poll posted by ${username}`);
				chnl.send(embed_msg)
				.then(function(msg) {
					msg.react('✅');
					msg.react('❎');
					guild_client.on('messageReactionAdd', function(reaction, user){
						if(reaction.message.id === msg.id){
							if( ! user.bot && reaction.emoji.name !== '✅' || reaction.emoji.name !== '❎'){
								reaction.remove();
							}
							else{
								console.log(`${reaction.author.username} reacted to a poll...`);
							}
						}
					
					});
				});
			}
		
		});	
	}
	
}


function postAnnouncement(str, username, sev){
	guild_channels.array().forEach( function(chnl){
		// console.log(chnl);
		if(chnl.name === 'announcements' && chnl.manageable && chnl.type === 'text'){
			// getting the text from a file and sending it to the server channel 'role assignment'
			let message = str;
				
			let embed_msg = new discord.RichEmbed();
				embed_msg.setTitle('Announcement');
				embed_msg.setDescription(message);
				embed_msg.setColor(msg_sevarity[sev].color);
				embed_msg.setFooter(`Announcement posted by ${username}`);
			chnl.send(embed_msg)
			.then((msg) => {
				if(msg_sevarity[sev].here === true)
					chnl.send("@here");
				if(msg_sevarity[sev].everyone === true)
					chnl.send("@everyone");
			});
			
		}
	});	
}
